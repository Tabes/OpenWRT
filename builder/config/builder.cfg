################################################################################
### OpenWRT Custom Builder Configuration
### Builder-specific settings and paths
################################################################################
### File:    builder.cfg
### Version: 1.0.0
### Date:    2025-08-19
################################################################################

################################################################################
### PATH CONFIGURATION
################################################################################

### Base directories ###
BUILDER_DIR="${BUILDER_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"
PROJECT_ROOT="${PROJECT_ROOT:-$(dirname "$BUILDER_DIR")}"

### Builder subdirectories ###
OUTPUT_DIR="${OUTPUT_DIR:-$BUILDER_DIR/output}"
WORK_DIR="${WORK_DIR:-$BUILDER_DIR/work}"
LOG_DIR="${LOG_DIR:-$BUILDER_DIR/log}"
CACHE_DIR="${CACHE_DIR:-$BUILDER_DIR/cache}"
SCRIPT_DIR="${SCRIPTS_DIR:-$BUILDER_DIR/scripts}"
BOOT_DIR="${BOOT_DIR:-$BUILDER_DIR/boot}"
CONFIG_DIR="${CONFIG_DIR:-$BUILDER_DIR/config}"
TEMP_DIR="${TEMP_DIR:-$BUILDER_DIR/temp}"

### Mount points ###
MOUNT_ROOT="${MOUNT_ROOT:-$WORK_DIR/mount}"
MOUNT_BOOT="${MOUNT_BOOT:-$MOUNT_ROOT/boot}"
MOUNT_ROOTFS="${MOUNT_ROOTFS:-$MOUNT_ROOT/rootfs}"

### Cache paths ###
DEB_CACHE="${DEB_CACHE:-$CACHE_DIR/debian}"
KERNEL_CACHE="${KERNEL_CACHE:-$CACHE_DIR/kernel}"
BOOTLOADER_CACHE="${BOOTLOADER_CACHE:-$CACHE_DIR/bootloader}"
PACKAGE_CACHE="${PACKAGE_CACHE:-$CACHE_DIR/packages}"

################################################################################
### BUILD DEFAULTS
################################################################################

### Build type and target ###
DEFAULT_BUILD_TYPE="debian-luci"
DEFAULT_TARGET_DEVICE="bpi-r4"
DEFAULT_IMAGE_NAME="bpi-r4-custom"

### Image settings ###
DEFAULT_IMAGE_SIZE="8G"
DEFAULT_BOOT_SIZE="256M"
DEFAULT_ROOT_SIZE="0"  ### 0 = use remaining space ###

### Compression ###
DEFAULT_COMPRESS="true"
DEFAULT_COMPRESS_TYPE="xz"  ### xz, gzip, bzip2 ###
DEFAULT_COMPRESS_LEVEL="9"  ### 1-9 ###

### Parallel processing ###
DEFAULT_PARALLEL_JOBS="$(nproc)"
DEFAULT_PARALLEL_DOWNLOADS="4"

################################################################################
### SYSTEM CONFIGURATION
################################################################################

### Debian settings ###
DEFAULT_DEBIAN_VERSION="bookworm"
DEFAULT_DEBIAN_MIRROR="http://deb.debian.org/debian"
DEFAULT_DEBIAN_ARCH="arm64"
DEFAULT_DEBIAN_COMPONENTS="main contrib non-free non-free-firmware"

### Kernel settings ###
DEFAULT_KERNEL_VERSION="6.6"
DEFAULT_KERNEL_SOURCE="frank-w"  ### frank-w, mainline, bpi-official ###
DEFAULT_KERNEL_CONFIG="defconfig"

### Bootloader settings ###
DEFAULT_BOOTLOADER="u-boot"
DEFAULT_BOOTLOADER_SOURCE="frank-w"
DEFAULT_BOOT_TIMEOUT="3"

################################################################################
### NETWORK CONFIGURATION
################################################################################

### Default network settings ###
DEFAULT_HOSTNAME="bpi-r4"
DEFAULT_DOMAIN="local"
DEFAULT_ROOT_PASSWORD="bananapi"

### LAN configuration ###
DEFAULT_LAN_IP="192.168.1.1"
DEFAULT_LAN_NETMASK="255.255.255.0"
DEFAULT_LAN_DHCP_START="100"
DEFAULT_LAN_DHCP_END="200"
DEFAULT_LAN_DHCP_LEASE="12h"

### WAN configuration ###
DEFAULT_WAN_PROTO="dhcp"  ### dhcp, static, pppoe ###
DEFAULT_WAN_IP=""
DEFAULT_WAN_NETMASK=""
DEFAULT_WAN_GATEWAY=""
DEFAULT_WAN_DNS1="8.8.8.8"
DEFAULT_WAN_DNS2="8.8.4.4"

################################################################################
### FEATURE FLAGS
################################################################################

### Enable/disable features ###
DEFAULT_ENABLE_LUCI="true"
DEFAULT_ENABLE_DOCKER="false"
DEFAULT_ENABLE_WIFI="true"
DEFAULT_ENABLE_SSH="true"
DEFAULT_ENABLE_FIREWALL="true"
DEFAULT_ENABLE_MONITORING="false"
DEFAULT_ENABLE_WEBMIN="false"
DEFAULT_ENABLE_COCKPIT="false"

### Package selections ###
DEFAULT_INSTALL_BASIC="true"
DEFAULT_INSTALL_NETWORK="true"
DEFAULT_INSTALL_WIRELESS="true"
DEFAULT_INSTALL_DEVELOPMENT="false"
DEFAULT_INSTALL_EXTRA="false"

################################################################################
### LOGGING CONFIGURATION
################################################################################

### Log settings ###
LOG_LEVEL="INFO"  ### DEBUG, INFO, WARNING, ERROR ###
LOG_TO_FILE="true"
LOG_TO_CONSOLE="true"
LOG_TIMESTAMP="true"
LOG_COLOR="true"
LOG_ROTATE="true"
LOG_MAX_SIZE="10M"
LOG_MAX_FILES="5"

################################################################################
### BUILD OPTIONS
################################################################################

### Build behavior ###
AUTO_CLEANUP="true"
AUTO_RETRY="true"
MAX_RETRIES="3"
RETRY_DELAY="5"

### Validation ###
VALIDATE_CHECKSUMS="true"
VALIDATE_SIGNATURES="false"
STRICT_MODE="false"

### Cache behavior ###
USE_CACHE="true"
CACHE_EXPIRE_DAYS="7"
CLEAR_CACHE_ON_ERROR="false"

################################################################################
### DOWNLOAD URLS
################################################################################

### Kernel sources ###
KERNEL_URL_FRANK_W="https://github.com/frank-w/BPI-Router-Linux/releases"
KERNEL_URL_MAINLINE="https://cdn.kernel.org/pub/linux/kernel"
KERNEL_URL_BPI="https://github.com/BPI-SINOVOIP/BPI-R4-bsp/releases"

### Bootloader sources ###
BOOTLOADER_URL_FRANK_W="https://github.com/frank-w/u-boot/releases"
BOOTLOADER_URL_OFFICIAL="https://github.com/mtk-openwrt/u-boot/releases"
ATF_URL="https://github.com/mtk-openwrt/arm-trusted-firmware/releases"

### OpenWrt sources ###
OPENWRT_URL="https://downloads.openwrt.org/snapshots"
LUCI_URL="https://github.com/openwrt/luci.git"
UCI_URL="https://git.openwrt.org/project/uci.git"
UBUS_URL="https://git.openwrt.org/project/ubus.git"

################################################################################
### DEVICE-SPECIFIC SETTINGS
################################################################################

### BPI-R4 specific ###
BPI_R4_DTB="mt7988a-bananapi-bpi-r4.dtb"
BPI_R4_BOOT_OFFSET="4096"  ### Sectors ###
BPI_R4_ENV_OFFSET="8192"   ### Sectors ###
BPI_R4_ENV_SIZE="2048"     ### Sectors ###

### Partition layout ###
PARTITION_TABLE="gpt"
PARTITION_ALIGN="2048"  ### Sectors ###
BOOT_PARTITION_TYPE="0700"  ### Microsoft basic data ###
ROOT_PARTITION_TYPE="8300"  ### Linux filesystem ###

################################################################################
### HELPER FUNCTIONS
################################################################################

### Export all builder variables ###
export_builder_vars() {
    export BUILDER_DIR PROJECT_ROOT
    export OUTPUT_DIR WORK_DIR LOG_DIR CACHE_DIR
    export SCRIPTS_DIR BOOT_DIR CONFIG_DIR TEMP_DIR
    export MOUNT_ROOT MOUNT_BOOT MOUNT_ROOTFS
    export DEB_CACHE KERNEL_CACHE BOOTLOADER_CACHE PACKAGE_CACHE
}

### Validate configuration ###
validate_config() {
    local errors=0
    
    ### Check required directories ###
    [ -d "$BUILDER_DIR" ] || { echo "ERROR: BUILDER_DIR not found: $BUILDER_DIR"; ((errors++)); }
    [ -d "$PROJECT_ROOT" ] || { echo "ERROR: PROJECT_ROOT not found: $PROJECT_ROOT"; ((errors++)); }
    
    ### Check disk space ###
    local available=$(df "$BUILDER_DIR" | awk 'NR==2 {print $4}')
    local required=$((20 * 1024 * 1024))  ### 20GB in KB ###
    [ "$available" -lt "$required" ] && { echo "ERROR: Insufficient disk space"; ((errors++)); }
    
    return $errors
}

### Print configuration summary ###
print_config_summary() {
    echo "################################################################################"
    echo "### Builder Configuration Summary"
    echo "################################################################################"
    echo "### Paths:"
    echo "###   Builder Dir:    $BUILDER_DIR"
    echo "###   Output Dir:     $OUTPUT_DIR"
    echo "###   Work Dir:       $WORK_DIR"
    echo "###   Cache Dir:      $CACHE_DIR"
    echo "### Build:"
    echo "###   Type:           $DEFAULT_BUILD_TYPE"
    echo "###   Target:         $DEFAULT_TARGET_DEVICE"
    echo "###   Image Size:     $DEFAULT_IMAGE_SIZE"
    echo "### Network:"
    echo "###   Hostname:       $DEFAULT_HOSTNAME"
    echo "###   LAN IP:         $DEFAULT_LAN_IP"
    echo "################################################################################"
}

################################################################################
### AUTO-LOAD GLOBAL CONFIG
################################################################################

### Source global config if available ###
if [ -f "$PROJECT_ROOT/config/global.cfg" ]; then
    source "$PROJECT_ROOT/config/global.cfg"
fi

### Export variables on load ###
export_builder_vars

################################################################################
### END OF CONFIGURATION
################################################################################