#!/bin/ash
### BPI-R4 Clean Slate Router Configuration Script ###
### Deletes all Network Configs and Rebuilds from Scratch ###
### Execute as root via SSH ###

### === LOAD GLOBAL CONFIGURATION === ###
GLOBAL_CONFIG="/root/openWRT/global.cfg"
if [ ! -f "$GLOBAL_CONFIG" ]; then
    echo "ERROR: Global configuration file not found: $GLOBAL_CONFIG"
    echo "Please ensure global.cfg exists before running this script."
    exit 1
fi

### Load global configuration ###
. "$GLOBAL_CONFIG"

set -e  ### Exit on any error ###

### === LOGGING FUNCTIONS === ###
log_message() {
    MESSAGE="$1"
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$TIMESTAMP] $MESSAGE" | tee -a "$LOG_FILE"
    echo ""
}

log_separator() {
    echo "================================================================================" | tee -a "$LOG_FILE"
}

### === CREATE DIRECTORIES === ###
mkdir -p "$LOG_PATH"
mkdir -p "$BACKUP_PATH"

log_separator
log_message "Starting complete interface cleanup..."
log_separator

### === BACKUP CURRENT CONFIGURATION === ###

log_message "Creating complete backup..."
BACKUP_DIR="$BACKUP_PATH/interface_$(date +%Y%m%d-%H%M)"
mkdir -p "$BACKUP_DIR"
uci export network > "$BACKUP_DIR/network-full.txt"
uci export dhcp > "$BACKUP_DIR/dhcp-full.txt"
uci export wireless > "$BACKUP_DIR/wireless-full.txt" 2>/dev/null || true
log_message "Backup saved to $BACKUP_DIR/"

### === DYNAMIC INTERFACE DELETION === ###

log_message "Scanning and deleting all network interfaces..."

### Get list of all interface sections ###
INTERFACES=$(uci show network | grep "network\." | grep "=interface" | cut -d'.' -f2 | cut -d'=' -f1 | sort -u)

### Delete each interface found ###
for iface in $INTERFACES; do
    echo "Deleting interface: $iface" | tee -a "$LOG_FILE"
    uci delete network.$iface 2>/dev/null || true
done

log_message "Scanning and deleting all device sections..."

### Get list of all device sections ###
DEVICES=$(uci show network | grep "network\." | grep "=device" | cut -d'.' -f2 | cut -d'=' -f1 | sort -u)

### Delete each device found ###
for device in $DEVICES; do
    echo "Deleting device: $device" | tee -a "$LOG_FILE"
    uci delete network.$device 2>/dev/null || true
done

### Delete any remaining anonymous sections ###
log_message "Cleaning up anonymous sections..."

### Delete all @device sections ###
while uci delete network.@device[0] 2>/dev/null; do
    echo "Deleted anonymous device section" | tee -a "$LOG_FILE"
done

### Delete all @interface sections ###
while uci delete network.@interface[0] 2>/dev/null; do
    echo "Deleted anonymous interface section" | tee -a "$LOG_FILE"
done

### Delete all switch and switch_vlan sections ###
while uci delete network.@switch[0] 2>/dev/null; do
    echo "Deleted switch section" | tee -a "$LOG_FILE"
done

while uci delete network.@switch_vlan[0] 2>/dev/null; do
    echo "Deleted switch_vlan section" | tee -a "$LOG_FILE"
done

### Delete all switch_port sections ###
while uci delete network.@switch_port[0] 2>/dev/null; do
    echo "Deleted switch_port section" | tee -a "$LOG_FILE"
done

### === DELETE DHCP INTERFACES === ###

log_message "Cleaning up DHCP interface configurations..."

### Get list of all DHCP sections ###
DHCP_SECTIONS=$(uci show dhcp | grep "dhcp\." | grep "=dhcp" | cut -d'.' -f2 | cut -d'=' -f1 | sort -u)

### Delete each DHCP section found ###
for dhcp_iface in $DHCP_SECTIONS; do
    echo "Deleting DHCP config: $dhcp_iface" | tee -a "$LOG_FILE"
    uci delete dhcp.$dhcp_iface 2>/dev/null || true
done

### Delete anonymous DHCP sections ###
while uci delete dhcp.@dhcp[0] 2>/dev/null; do
    echo "Deleted anonymous DHCP section" | tee -a "$LOG_FILE"
done

### === CREATE MINIMAL LOOPBACK === ###

log_message "Creating minimal loopback interface..."

### Loopback is essential for system operation ###
uci set network.loopback=interface
uci set network.loopback.ifname='lo'
uci set network.loopback.proto='static'
uci set network.loopback.ipaddr='127.0.0.1'
uci set network.loopback.netmask='255.0.0.0'

### === SHOW CLEANUP RESULTS === ###

log_separator
log_message "CLEANUP COMPLETED"
log_separator

log_message "Remaining network sections:"
uci show network 2>/dev/null | tee -a "$LOG_FILE" || echo "No network sections remaining" | tee -a "$LOG_FILE"

echo "" | tee -a "$LOG_FILE"

log_message "Remaining DHCP sections:"
uci show dhcp 2>/dev/null | tee -a "$LOG_FILE" || echo "No DHCP sections remaining" | tee -a "$LOG_FILE"

### === COMMIT WITHOUT RESTART === ###

log_separator
log_message "Committing changes (NOT restarting network yet)..."
uci commit network
uci commit dhcp

log_separator
log_message "ALL INTERFACES DELETED"
log_message "Only loopback interface remains"
log_message "Configuration backup saved to: $BACKUP_DIR/"
log_message "WARNING: Network connectivity may be lost!"
log_message "Run your interface.cfg script immediately to restore connectivity"
log_message "To restart network manually: /etc/init.d/network restart"
log_separator